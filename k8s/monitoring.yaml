---
# Prometheus ServiceMonitor for YOLO (requires Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: yolo-monitor
  namespace: vision-system
  labels:
    app: yolo
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: yolo
      component: inference
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
# Prometheus ServiceMonitor for Logging
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: logging-monitor
  namespace: vision-system
  labels:
    app: logging
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: logging
      component: storage
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s

---
# PrometheusRule for alerting
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: vision-system-rules
  namespace: vision-system
  labels:
    prometheus: kube-prometheus
spec:
  groups:
    - name: vision.rules
      interval: 30s
      rules:
        - alert: YOLOHighCPUUsage
          expr: 'sum(rate(container_cpu_usage_seconds_total{pod=~"yolo-.*"}[5m])) > 3'
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage in YOLO service"
            description: "YOLO pod {{ $labels.pod }} has high CPU usage"

        - alert: YOLOHighMemoryUsage
          expr: 'sum(container_memory_usage_bytes{pod=~"yolo-.*"}) / 1024^3 > 6'
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage in YOLO service"
            description: "YOLO pod {{ $labels.pod }} is using {{ $value }}GB memory"

        - alert: LoggingServiceDown
          expr: 'up{job="logging-service"} == 0'
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Logging service is down"
            description: "Logging service has been unavailable for more than 1 minute"

        - alert: LoggingHighErrorRate
          expr: 'rate(logging_errors_total[5m]) > 0.05'
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate in logging service"
            description: "Logging service error rate is {{ $value }} errors/sec"

        - alert: YOLOPodRestartingFrequently
          expr: 'rate(kube_pod_container_status_restarts_total{pod=~"yolo-.*"}[15m]) > 0'
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "YOLO pod restarting frequently"
            description: "YOLO pod {{ $labels.pod }} has restarted {{ $value }} times in 15 minutes"

        - alert: PersistentVolumeClaimNearFull
          expr: 'kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes > 0.85'
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PVC {{ $labels.persistentvolumeclaim }} is 85% full"
            description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} is nearing capacity"
